# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#
###############手动修改##############
name: new36-6.6

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      LAN_IP:
        description: 'Set LAN IP Address'
        required: true
        default: '192.168.123.1'
      NO_DOCKERMAN:
        description: 'Not build luci-app-dockerman'
        required: true
        default: false
        type: boolean
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
#  schedule:
#    - cron: 0 16 * * *
    # ===================== 核心修改：修复wed.c第911行 =====================
  - name: 修复warp驱动wed.c类型转换错误
       run: |
        cd openwrt
        # 【关键】确认wed.c的源码路径（根据你的源码结构调整，以下是通用路径）
        WED_FILE="package/mtk/drivers/warp/src/wed.c"
        # 1. 检查文件是否存在，防止路径错误导致编译失败
        if [ ! -f "$WED_FILE" ]; then
          echo "❌ 错误：未找到目标文件 $WED_FILE，请确认源码路径！"
          # 可选：打印目录结构，帮助排查路径
          ls -l package/mtk/drivers/warp/src/ || true
          exit 1
        fi
        # 2. 精准替换第911行：移除(unsigned long)强制转换
        # sed语法说明：
        # 911s：定位第911行
        # 原内容：buf_free_task((unsigned long)wed);
        # 新内容：buf_free_task(wed);
        # 转义括号：\( 和 \) 是sed中匹配括号的转义符
        sed -i '911s/buf_free_task\(\(unsigned long\)wed\);/buf_free_task(wed);/' "$WED_FILE"
        # 3. 验证修改结果，打印第911行确认
        echo "✅ 已修改wed.c第911行，修改后内容："
        sed -n '911p' "$WED_FILE"
        # 可选：打印前后几行，确认上下文正确
        # sed -n '909,913p' "$WED_FILE"
  - name: 编译固件
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        
        # 尝试正常编译
        if ! make -j$(nproc); then
          echo "编译失败，尝试重新编译出错的包: package/mtk/drivers/warp"
          
          # 方法1：先清理并单独编译出错的包，输出详细日志
          echo "=== 开始单独编译 package/mtk/drivers/warp ==="
          make package/mtk/drivers/warp/clean V=s
          make package/mtk/drivers/warp/compile V=s 2>&1 | tee warp_compile.log
